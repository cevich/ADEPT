---

################################################################
# N/B: This may be running on an old (2.1)  version of ansible #
################################################################

- assert:
    that:
        - 'inventory_hostname == "kommandir"'
        - 'cloud_type is defined'
        - 'ansible_ssh_host is defined or ansible_host is defined'
        - 'cloud_type is defined'

- name: Key variables are displayed
  debug:
    var: "{{ item }}"
  when: adept_debug
  with_items: ["cloud_type","ansible_ssh_host","ansible_host","ansible_ssh_port","ansible_port","ansible_ssh_user","ansible_user","wait_for_timeout"]

- name: kommandir's ssh port is open from perspective of exekutir
  wait_for:
    # Old / deprecated names must take precedence 
    host: "{{ ansible_ssh_host | default(ansible_host) }}"
    port: "{{ ansible_ssh_port | default(ansible_port | default(22)) }}"
    # Fail quickly == retry sooner
    connect_timeout: 1
    # Minumum is two-DNS failures + one second
    timeout: "{{ wait_for_timeout | default( 13 ) }}"
    state: "started"
  # Run this from a node that actually exists
  delegate_to: exekutir
  # Show "Changed" anytime this runs for clarity.
  changed_when: True
  # Unless exekutir == kommandir
  when: '"nocloud" not in group_names'
  register: result
  # There are many reasons this can fail, only the last one matters
  retries: 10
  delay: 1

- name: The sleep command executes successfully on Kommandir
  command: "/bin/sleep 0.1"
  # Show "Changed" anytime this runs for clarity.
  changed_when: True
