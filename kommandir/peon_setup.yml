---

# N/B: This file can be overwritten by a copy from job_path.

- hosts: peons:!nocloud
  gather_facts: False  # Need peon_pre_raw_cmds run first
  # Outside of debug-mode, run all peons as fast as possible
  strategy: "{{ 'linear' if adept_debug else 'free' }}"
  vars_files:
      - kommandir_vars.yml
  pre_tasks:
    - name: Some hosts may need python2 installed before anything else happens.
      raw: "{{ item }}"  # raw commands don't require python
      args:
        executable: "/bin/bash"
      register: result
      with_items: '{{ peon_pre_raw_cmds | default([]) }}'
    - name: Peon's peon_pre_raw_cmds results are displayed
      debug:
          var: "item.stdout_lines"
      with_items: "{{ result.results }}"
      when: adept_debug
    - setup:
        gather_subset: 'facter'
  roles: # N/B: failed_peon_junit role applied via role dependencies
    - common
    - peon_common

      # Some roles should only ever be applied once
    - role: touchstone
      touch_touchstone: False

    - role: rendered
      when: rendered_templates | default() not in empty

    - role: subscribed
      when: not hostvars[inventory_hostname].stone_touched and
            rhsm is defined and
            "subscribed" in group_names and
            rhsm.username | default() not in empty and
            rhsm.password | default() not in empty

    - role: rawhide
      when: not hostvars[inventory_hostname].stone_touched and
            'fedora' in group_names and 'rawhide' in group_names

    - role: partitioned
      when: not hostvars[inventory_hostname].stone_touched and
            disk_device | default() not in empty and
            parted_cmds | default() not in empty

    - role: rebooted
      # Workaround "feature" of role only being applied once per play
      reboot_context: "beginning"
      when: needs_reboot == True

    - role: yumrepos
      when: disable_all_rh_repos | default(False) in [True,False] or
            enable_rh_repos | default() not in empty or
            yum_repos | default() not in empty

    - role: lvm
      when: lvg_ops | default() not in empty or
            lvol_ops | default() not in empty

    - role: swap_enabled
      when: swap_device | default() not in empty

    - role: installed
      when: not is_atomic and
            install_rpms | default() not in empty

    - role: atomic_rebase
      when: is_atomic and
            ostree_remote | default() not in empty and
            ostree_remote.name | default() not in empty and
            ostree_remote.url | default() not in empty and
            ostree_remote.spec | default() not in empty

    - role: atomic_upgrade
      when: is_atomic and
            ostree_remote | default() in empty and
            'updated' in group_names

    - role: rebooted
      reboot_context: "middle"
      when: needs_reboot == True

    - role: sysconfig_docker
      when: "ansible_distribution != 'Fedora'"

    - role: liverestore_enabled
      when: '"liverestore" in group_names'

    - role: docker-storage-setup
      when: not hostvars[inventory_hostname].stone_touched and
            sysconfig_dss_lines | default([]) != []

    - selinux_enforcing

    - services

    - role: rebooted
      reboot_context: "end"
      when: needs_reboot == True

    - role: autotested
      when: '"autotested" in group_names and docker_autotest is defined'

    - role: touchstone
      touch_touchstone: True
